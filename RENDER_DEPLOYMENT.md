# Render Deployment Guide

This guide provides step-by-step instructions for deploying the FastAPI Plotly Backend to Render.

## Prerequisites

1. **Render Account**: Sign up at [render.com](https://render.com)
2. **MongoDB Database**: MongoDB Atlas or other cloud MongoDB instance
3. **GitHub Repository**: Code pushed to GitHub

## Deployment Methods

### Option 1: Using render.yaml (Recommended)

This repository includes a `render.yaml` file for automatic configuration.

1. **Connect Repository**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Blueprint"
   - Connect your GitHub repository
   - Render will automatically detect `render.yaml`

2. **Configure Environment Variables** (see below)

3. **Deploy**
   - Click "Apply" to deploy
   - Render will run `build.sh` and start the service

### Option 2: Manual Web Service Creation

1. **Create New Web Service**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Select the `fastAPI-backend` repository

2. **Configure Settings**
   - **Name**: `fastapi-plotly-backend`
   - **Region**: Oregon (US West) or closest to you
   - **Branch**: `main`
   - **Runtime**: Python 3
   - **Build Command**: `./build.sh`
   - **Start Command**: `uvicorn main:app --host 0.0.0.0 --port $PORT`

3. **Set Environment Variables** (see below)

4. **Deploy**

## Required Environment Variables

### ⚠️ CRITICAL - Must Be Set Manually

| Variable | Value | Description |
|----------|-------|-------------|
| `MONGODB_URL` | `mongodb+srv://username:password@cluster.mongodb.net/` | Your MongoDB connection string from Atlas |

**How to get MongoDB URL:**
1. Go to [MongoDB Atlas](https://cloud.mongodb.com)
2. Navigate to your cluster
3. Click "Connect" → "Connect your application"
4. Copy the connection string
5. Replace `<password>` with your actual password
6. Paste into Render environment variable

### Auto-Configured (via render.yaml)

These are set automatically if using `render.yaml`:

| Variable | Default Value | Description |
|----------|---------------|-------------|
| `PYTHON_VERSION` | `3.11.0` | Python version |
| `DATABASE_NAME` | `fastapi_plotly_db` | MongoDB database name |
| `COLLECTION_NAME` | `plotly_data` | MongoDB collection name |
| `APP_NAME` | `FastAPI Plotly Backend` | Application name |
| `DEBUG` | `False` | Debug mode (disabled in production) |
| `ENVIRONMENT` | `production` | Environment setting |
| `SECRET_KEY` | *auto-generated* | Secret key for security (auto-generated by Render) |
| `RATE_LIMIT_PER_MINUTE` | `100` | API rate limiting |
| `MAX_REQUEST_SIZE` | `10485760` | Max request size (10MB) |
| `LOG_LEVEL` | `INFO` | Logging level |

## MongoDB Atlas Setup

If you don't have MongoDB Atlas configured:

1. **Create Account**
   - Go to [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
   - Sign up for free tier

2. **Create Cluster**
   - Click "Build a Database"
   - Choose "Shared" (Free tier)
   - Select your region (closest to Render deployment)
   - Click "Create Cluster"

3. **Create Database User**
   - Go to "Database Access"
   - Click "Add New Database User"
   - Create username/password
   - Set "Built-in Role" to "Atlas admin" or "Read and write to any database"
   - Click "Add User"

4. **Allow Network Access**
   - Go to "Network Access"
   - Click "Add IP Address"
   - Click "Allow Access from Anywhere" (0.0.0.0/0)
   - Click "Confirm"

5. **Get Connection String**
   - Go to "Database" → "Connect"
   - Choose "Connect your application"
   - Copy the connection string
   - Replace `<password>` with your database user password
   - Use this as `MONGODB_URL` in Render

## Post-Deployment Steps

### 1. Verify Deployment

Once deployed, Render will provide a URL like: `https://fastapi-plotly-backend.onrender.com`

Test these endpoints:
```bash
# Health check
curl https://fastapi-plotly-backend.onrender.com/health

# API root
curl https://fastapi-plotly-backend.onrender.com/

# CSRF token
curl https://fastapi-plotly-backend.onrender.com/csrf-token
```

### 2. Update Frontend CORS

If you're using the React frontend (`load-json-data`), add your Render URL to its API configuration:

```javascript
// In your React app
const API_URL = process.env.REACT_APP_API_URL || 'https://fastapi-plotly-backend.onrender.com';
```

### 3. Test API Integration

```bash
# Get CSRF token
curl -c cookies.txt https://fastapi-plotly-backend.onrender.com/csrf-token

# Extract token
TOKEN=$(grep XSRF-TOKEN cookies.txt | awk '{print $7}')

# Create test data
curl -b cookies.txt \
  -H "X-CSRF-Token: $TOKEN" \
  -H "Content-Type: application/json" \
  -X POST \
  -d '{"title":"Test","data":[{"x":[1,2,3],"y":[4,5,6]}],"layout":{}}' \
  https://fastapi-plotly-backend.onrender.com/plotly/
```

## Monitoring & Logs

### View Logs
- Go to your service in Render Dashboard
- Click "Logs" tab
- Monitor startup, requests, and errors

### Health Check
Render automatically monitors `/health` endpoint:
- Status page shows service health
- Automatic restarts on failures

### Metrics
- View CPU and Memory usage in Dashboard
- Monitor response times
- Track deployment history

## Troubleshooting

### Issue: Service fails to start

**Solution:**
1. Check logs for errors
2. Verify `MONGODB_URL` is set correctly
3. Ensure MongoDB allows connections from anywhere (0.0.0.0/0)
4. Check that `build.sh` is executable (should be by default)

### Issue: Database connection failed

**Solution:**
1. Verify MongoDB Atlas IP whitelist includes `0.0.0.0/0`
2. Check `MONGODB_URL` has correct username/password
3. Test connection string locally first
4. Ensure database user has proper permissions

### Issue: CORS errors from frontend

**Solution:**
1. Add frontend URLs to `main.py` CORS origins:
   ```python
   allow_origins=[
       "http://localhost:3000",
       "https://your-frontend.vercel.app",
       # Add more as needed
   ]
   ```
2. Redeploy after changes

### Issue: 503 Service Unavailable

**Solution:**
- Free tier services sleep after 15 minutes of inactivity
- First request after sleep may take 30-60 seconds
- Consider upgrading to paid plan to prevent sleeping

## Performance Optimization

### Free Tier Limitations
- Service sleeps after 15 minutes of inactivity
- 512 MB RAM
- Shared CPU
- 750 hours/month free (enough for 1 service 24/7)

### Keep Service Awake (Optional)
Use a service like UptimeRobot or cron-job.org to ping your health endpoint every 10 minutes:
```
https://fastapi-plotly-backend.onrender.com/health
```

## Security Checklist

- ✅ HTTPS enabled by default on Render
- ✅ `secure=True` set for cookies (HTTPS required)
- ✅ CORS restricted to specific origins
- ✅ Trusted hosts configured
- ✅ Rate limiting enabled
- ✅ CSRF protection active
- ✅ Security headers configured
- ✅ MongoDB connection uses secure connection string

## Updating the Application

### Method 1: Auto-Deploy (Recommended)
- Push changes to GitHub `main` branch
- Render automatically detects and deploys

### Method 2: Manual Deploy
- Go to Render Dashboard
- Click "Manual Deploy" → "Deploy latest commit"

## Rollback

If a deployment fails:
1. Go to Render Dashboard
2. Click "Rollback" to previous version
3. Or push a fix to GitHub and redeploy

## Cost Considerations

**Free Tier:**
- 750 hours/month free
- 512 MB RAM
- Service sleeps after 15 minutes inactivity
- Perfect for testing and low-traffic apps

**Starter Plan ($7/month):**
- No sleeping
- 512 MB RAM
- Better for production use

**Standard Plan ($25/month):**
- 2 GB RAM
- Priority support
- Better performance

## Additional Resources

- [Render Documentation](https://render.com/docs)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [MongoDB Atlas Documentation](https://www.mongodb.com/docs/atlas/)
- [Project README](./README.md)
- [CSRF Documentation](./CSRF_DOCUMENTATION.md)

## Support

For issues:
1. Check Render logs first
2. Verify all environment variables
3. Test MongoDB connection separately
4. Review this deployment guide

---

**Deployment Date**: November 2024  
**Last Updated**: November 2, 2024
